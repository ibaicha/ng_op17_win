<p-toast [style]="{ marginTop: '80px' }"></p-toast>

<p-panel>
  <p-header>
    <div class="flex-container">
      <div class="flex-item-start">
        CAMPAGNE:
        <B
          >{{ this.appService.getLocalselectedCampagneAnneeName() }} |
          {{ this.appService.getLocalselectedCampagneSaisonName() }}</B
        >
      </div>
      <div class="flex-item-center">
        VARIETE: <B>{{ this.appService.getLocalselectedVarieteName() }}</B>
      </div>
      <div class="flex-item-end">
        OP: <B>{{ this.appService.getLocalselectedOpName() }}</B>
      </div>
    </div>
  </p-header>
  @if (exploitationCustom) {
  <!--
    <div class="flex">
      <div class="flex-1 h-2rem font-bold text-center p-4 border-round">
        <i style="font-size:small;"> Date: </i> <i style="font-size: small; color: #000;">{{this.formatDate(this.exploitationCustom!.date)}}</i>
      </div>
      <div class="flex-1 h-2rem font-bold text-center p-4 border-round">
        <i style="font-size: small;"> Compte N°: </i> <i style="font-size: small; color: #000;">{{ this.exploitationCustom!.compte}}</i>
      </div>
      <div class="flex-1 h-2rem font-bold text-center p-4 border-round">
        <i style="font-size: small;"> Campagne: </i> <i style="font-size: small; color: #000;">{{ this.exploitationCustom!.annee.name + " | " + this.exploitationCustom!.saison.name }}</i>
      </div>
    </div>
    <div class="flex">
      <div class="flex-1 h-2rem font-bold text-center p-4 border-round">
        <i style="font-size: small;"> Surface: </i> <i style="font-size: small; color: #000;">{{this.formatMontant(this.exploitationCustom!.surface) + " " + this.exploitationCustom!.unite}}</i>
      </div>
      <div class="flex-1 h-2rem font-bold text-center p-4 border-round">
        <i style="font-size:small;"> Produit: </i> <i style="font-size: small; color: #000;">{{this.exploitationCustom!.variete.produit.name + " | " +this.exploitationCustom!.variete.name}}</i>
      </div>
      <div class="flex-1 h-2rem font-bold text-center p-4 border-round">
        <i style="font-size: small;"></i>
      </div>
    </div>
    <br>
    -->

  <p-steps
    [style]="{ color: 'blue' }"
    [model]="dialogPages"
    [(activeIndex)]="dialogPageIndex"
    [readonly]="false"
  >
  </p-steps>
  <br />

  @switch (dialogPageIndex) { @case (PageNames.DebutPage) {
  <div>
    <p-toolbar [style]="{ 'background-color': '#3498db', color: '#ffffff' }">
      <div class="p-toolbar-group-center">
        <i class="pi pi-info-circle" style="font-size: 1.4rem">
          RESUME EXPLOITATION
        </i>
      </div>
    </p-toolbar>
    <br />
    <div>
      <table [style]="{ width: '100%', border: 'none' }">
        <tr>
          <td
            [style]="{
              'text-align': 'center',
              width: '28%',
              'vertical-align': 'top'
            }"
          >
            <table>
              <tr>
                <th
                  colspan="2"
                  style="text-align: center; background-color: aqua"
                >
                  COMPTE
                </th>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">N°</th>
                <td [style]="{ 'text-align': 'left' }">
                  {{ this.exploitationCustom!.compte }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Date</th>
                <td [style]="{ 'text-align': 'left' }">
                  {{ this.formatDate(this.exploitationCustom!.date) }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Campage</th>
                <td [style]="{ 'text-align': 'left' }">
                  {{
                    this.exploitationCustom!.annee.name +
                      " | " +
                      this.exploitationCustom!.saison.name
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Produit</th>
                <td [style]="{ 'text-align': 'left' }">
                  {{
                    this.exploitationCustom!.variete.produit.name +
                      " | " +
                      this.exploitationCustom!.variete.name
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Surface</th>
                <td [style]="{ 'text-align': 'left' }">
                  {{
                    this.formatMontant(this.exploitationCustom!.surface) +
                      " " +
                      this.exploitationCustom!.unite
                  }}
                </td>
              </tr>
            </table>
          </td>
          <td
            [style]="{
              'text-align': 'center',
              width: '24%',
              'vertical-align': 'top'
            }"
          >
            <table>
              <tr>
                <th
                  colspan="2"
                  style="text-align: center; background-color: aqua"
                >
                  CREDITS
                </th>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Capital</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(
                      this.exploitationCustom.credits[0].capital
                    ) + " FCFA"
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">interet</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(
                      this.exploitationCustom.credits[0].interet
                    ) + " FCFA"
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Différé</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(
                      this.exploitationCustom.credits[0].moratoire
                    ) + " FCFA"
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Autres</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(
                      this.exploitationCustom.credits[0].autres_engagements
                    ) + " FCFA"
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Exigibles</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{ this.formatMontant(this.exploitationExigible) + " FCFA" }}
                </td>
              </tr>
            </table>
          </td>
          <td
            [style]="{
              'text-align': 'center',
              width: '24%',
              'vertical-align': 'top'
            }"
          >
            <table>
              <tr>
                <th
                  colspan="2"
                  style="text-align: center; background-color: aqua"
                >
                  RECOLTES
                </th>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Quantité</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(this.exploitationQuantiteRecolte) +
                      " Tonne(s)"
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Rendement</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(this.exploitationTauxRecolte) +
                      " Tonne(s) / Ha"
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Valeur</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(this.exploitationValeurRecolte) + " FCFA"
                  }}
                </td>
              </tr>
            </table>
          </td>
          <td
            [style]="{
              'text-align': 'center',
              width: '24%',
              'vertical-align': 'top'
            }"
          >
            <table>
              <tr>
                <th
                  colspan="2"
                  style="text-align: center; background-color: aqua"
                >
                  REMBOURSEMENTS
                </th>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Quantité</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(this.exploitationQuantiteRecolte) +
                      " Tonne(s)"
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Taux</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(this.exploitationTauxRecolte) +
                      " Tonne(s) / Ha"
                  }}
                </td>
              </tr>
              <tr>
                <th [style]="{ 'text-align': 'left' }">Valeur</th>
                <td [style]="{ 'text-align': 'right' }">
                  {{
                    this.formatMontant(this.exploitationValeurRecolte) + " FCFA"
                  }}
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </div>

    <p-footer>
      <p-toolbar>
        <div class="p-toolbar-group-start">
          <p-button
            icon="pi pi-arrow-left"
            (click)="allerAvant()"
            label="Retour"
            styleClass="p-button-text"
          ></p-button>
        </div>
        <div class="p-toolbar-group-end"></div>
      </p-toolbar>
    </p-footer>
  </div>
  } @case (PageNames.DeuxPage) {
  <div>
    <div>
      <p-toolbar [style]="{ 'background-color': '#3498db', color: '#ffffff' }">
        <div class="p-toolbar-group-center">
          <i class="pi pi-info-circle" style="font-size: 1.4rem">
            {{ messageRecoltes }}
          </i>
        </div>
      </p-toolbar>
    </div>
    <br />
    <div>
      @if (recoltesCustom.length > 0){
      <p-table
        #myTabRecoltes
        [value]="this.recoltesCustom"
        [columns]="colsRecoltes"
        responsiveLayout="scroll"
        [tableStyle]="{ 'min-width': '50rem' }"
        styleClass="p-datatable-sm"
        dataKey="id"
        sortMode="single"
        rowExpandMode="single"
        [rows]="5"
        [paginator]="true"
        [rowHover]="true"
        [showCurrentPageReport]="true"
        [scrollable]="true"
        [responsive]="true"
      >
        <ng-template pTemplate="header" let-columns>
          <tr>
            @for (col of columns; track $index) {
            <th [pSortableColumn]="col.field">
              @if (col.filter) {
              <p-columnFilter
                type="text"
                [field]="col.field"
                display="menu"
                class="ml-auto"
              ></p-columnFilter>
              }
              {{ col.header }}
              @if (col.sort) {
              <p-sortIcon [field]="col.field"></p-sortIcon>
              }
            </th>
            }
          </tr>
        </ng-template>
        <ng-template
          pTemplate="body"
          let-rowData
          let-columns="columns"
          let-expanded="expanded"
        >
          <tr>
            @for (col of columns; track $index) { @switch (true) { @default {
            @if( col.field == 'date') {
            <td [style]="{ 'text-align': 'center' }">
              <span>{{ this.formatDate(rowData[col.field]) }}</span>
            </td>

            } @else if ( col.field == 'quantite') {
            <td [style]="{ 'text-align': 'right' }">
              <span>{{ this.formatMontant(rowData[col.field]) }}</span>
            </td>
            } @else if ( col.field == 'pu') {
            <td [style]="{ 'text-align': 'right' }">
              <span>{{ this.formatMontant(rowData[col.field]) }}</span>
            </td>
            } @else if ( col.field == 'valeur') {
            <td [style]="{ 'text-align': 'right' }">
              <span>{{
                this.formatMontant(rowData[col.field]) + " FCFA"
              }}</span>
            </td>
            } @else {
            <td>
              <span>{{ rowData[col.field] }}</span>
            </td>
            } } } }
          </tr>
        </ng-template>
      </p-table>

      <p-toolbar [style]="{ 'background-color': '#3498db', color: '#ffffff' }">
        <div class="p-toolbar-group-start">
          <i class="pi pi-info-circle" style="font-size: 1.4rem">
            Au total : {{ myTabRecoltes.value.length }} recoltes(s).
          </i>
        </div>
        <div class="p-toolbar-group-end">
          <i class="pi pi-info-circle" style="font-size: 1.4rem">
            Recoltes :
            {{ formatMontant(this.getTotalMontants(myTabRecoltes)) + " FCFA" }}
          </i>
        </div>
      </p-toolbar>

      }
    </div>

    <br />
    <p-footer>
      <p-toolbar>
        <div class="p-toolbar-group-start"></div>
        <div class="p-toolbar-group-end">
          <p-button
            icon="pi pi-arrow-right"
            (click)="allerSuivant()"
            label="Suivant"
            styleClass="p-button-text"
          ></p-button>
        </div>
      </p-toolbar>
    </p-footer>
  </div>
  }
  <!--
      @case (PageNames.TroisPage) {
        <div>
          <div>
            <p-toolbar [style]="{ 'background-color': '#3498db', 'color': '#ffffff' }">
              <div class="p-toolbar-group-center">
                <i class="pi pi-info-circle" style="font-size: 1.4rem">
                  {{messageRemboursements}}
                </i>
              </div>
          </p-toolbar>
          </div>
          <br>
          <div>
            @if (remboursementsCustom.length > 0){
            <p-table
            #myTabRemboursements
            [value]="this.remboursementsCustom"
            [columns]="colsRemboursements"
            responsiveLayout="scroll"
            [tableStyle]="{'min-width': '50rem'}"
            styleClass="p-datatable-sm"
            dataKey="id"
            sortMode="single"
            rowExpandMode ="single"
            [rows]="5"
            [paginator]="true"
            [rowHover]="true"
            [showCurrentPageReport]="true"
            [scrollable]="true"
            [responsive]="true">
            <ng-template pTemplate="header" let-columns>
                <tr >
                    @for (col of columns; track $index) {
                        <th   [pSortableColumn]="col.field">

                            @if (col.filter) {
                                <p-columnFilter   type="text" [field]="col.field" display="menu" class="ml-auto"></p-columnFilter>
                            }
                            {{col.header}}
                            @if (col.sort) {
                                <p-sortIcon   [field]="col.field"></p-sortIcon>
                            }


                        </th>
                    }

                </tr>

            </ng-template>
            <ng-template pTemplate="body" let-rowData let-columns="columns" let-expanded="expanded">
                <tr>
                  @for (col of columns; track $index) {
                    @switch (true) {
                        @default {
                        @if( col.field == 'date') {
                          <td [style]=" { 'text-align': 'center' }">
                              <span>{{this.formatDate(rowData[col.field])}}</span>
                          </td>
                        }
                        @else if ( col.field == 'quantite') {
                            <td [style]=" { 'text-align': 'right' }">
                              <span>{{ this.formatMontant(rowData[col.field])}}</span>
                          </td>
                        }
                        @else if ( col.field == 'pu') {
                          <td [style]=" { 'text-align': 'right' }">
                              <span>{{ this.formatMontant(rowData[col.field])}}</span>
                          </td>
                        }
                        @else if ( col.field == 'valeur') {
                          <td [style]=" { 'text-align': 'right' }">
                              <span>{{ this.formatMontant(rowData[col.field]) + " FCFA"}}</span>
                          </td>
                        }
                        @else {
                          <td>
                              <span>{{rowData[col.field]}}</span>
                          </td>
                        }

                        }
                    }
                }

                </tr>
            </ng-template>
            </p-table>


            <p-toolbar [style]="{ 'background-color': '#3498db', 'color': '#ffffff' }">
                <div class="p-toolbar-group-start ">
                <i class="pi pi-info-circle" style="font-size: 1.4rem">
                  Au total : {{myTabRemboursements.value.length }} remboursement(s).
                </i>
                </div>
                <div class="p-toolbar-group-end " >
                  <i class="pi pi-info-circle" style="font-size: 1.4rem">
                 Remboursements : {{ formatMontant(this.getTotalMontants(myTabRemboursements)) + " FCFA" }}
                </i>

                </div>
              </p-toolbar>

          }
          </div>

          <br>
          <p-footer>
            <p-toolbar>
                <div class="p-toolbar-group-start">
                  <p-button icon="pi pi-arrow-left" (click)="allerAvant()" label="Retour" styleClass="p-button-text"></p-button>
                </div>
                <div class="p-toolbar-group-end">
                    <p-button icon= "pi pi-arrow-right"    (click)="allerSuivant()"   label="Suivant" styleClass="p-button-text"></p-button>
                </div>
            </p-toolbar>
        </p-footer>

        </div>
      }
      -->
  @case (PageNames.TroisPage) {
  <div>
    <div>
      <p-toolbar [style]="{ 'background-color': '#3498db', color: '#ffffff' }">
        <div class="p-toolbar-group-center">
          <i class="pi pi-info-circle" style="font-size: 1.4rem">
            {{ messageMouvements }}
          </i>
        </div>
      </p-toolbar>
    </div>
    <br />
    <div>
      @if (mouvementStockagesCustom.length > 0){
      <p-table
        #myTabMouvementStockagesCustom
        [value]="this.mouvementStockagesCustom"
        [columns]="colsMouvements"
        responsiveLayout="scroll"
        [tableStyle]="{ 'min-width': '50rem' }"
        styleClass="p-datatable-sm"
        dataKey="id"
        sortMode="single"
        rowExpandMode="single"
        [rows]="5"
        [paginator]="true"
        [rowHover]="true"
        [showCurrentPageReport]="true"
        [scrollable]="true"
        [responsive]="true"
      >
        <ng-template pTemplate="header" let-columns>
          <tr>
            @for (col of columns; track $index) {
            <th [pSortableColumn]="col.field">
              @if (col.filter) {
              <p-columnFilter
                type="text"
                [field]="col.field"
                display="menu"
                class="ml-auto"
              ></p-columnFilter>
              }
              {{ col.header }}
              @if (col.sort) {
              <p-sortIcon [field]="col.field"></p-sortIcon>
              }
            </th>
            }
          </tr>
        </ng-template>
        <ng-template
          pTemplate="body"
          let-rowData
          let-columns="columns"
          let-expanded="expanded"
        >
          <tr>
            @for (col of columns; track $index) { @switch (true) { @default {
            @if( col.field == 'date') {
            <td [style]="{ 'text-align': 'center' }">
              <span>{{ this.formatDate(rowData[col.field]) }}</span>
            </td>
            } @else if ( col.field == 'quantite') {
            <td [style]="{ 'text-align': 'right' }">
              <span>{{ this.formatMontant(rowData[col.field]) }}</span>
            </td>
            } @else if ( col.field == 'pu') {
            <td [style]="{ 'text-align': 'right' }">
              <span>{{ this.formatMontant(rowData[col.field]) }}</span>
            </td>
            } @else if ( col.field == 'valeur') {
            <td [style]="{ 'text-align': 'right' }">
              <span>{{
                this.formatMontant(rowData[col.field]) + " FCFA"
              }}</span>
            </td>
            } @else {
            <td>
              <span>{{ rowData[col.field] }}</span>
            </td>
            } } } }
          </tr>
        </ng-template>
      </p-table>

      <p-toolbar [style]="{ 'background-color': '#3498db', color: '#ffffff' }">
        <div class="p-toolbar-group-start">
          <i class="pi pi-info-circle" style="font-size: 1.4rem">
            Au total :
            {{ myTabMouvementStockagesCustom.value.length }} remboursement(s).
          </i>
        </div>
        <div class="p-toolbar-group-end">
          <i class="pi pi-info-circle" style="font-size: 1.4rem">
            Remboursements :
            {{
              formatMontant(
                this.getTotalMontants(myTabMouvementStockagesCustom)
              ) + " FCFA"
            }}
          </i>
        </div>
      </p-toolbar>

      }
    </div>

    <br />
    <p-footer>
      <p-toolbar>
        <div class="p-toolbar-group-start">
          <p-button
            icon="pi pi-arrow-left"
            (click)="allerAvant()"
            label="Retour"
            styleClass="p-button-text"
          ></p-button>
        </div>
        <div class="p-toolbar-group-end">
          <p-button
            icon="pi pi-arrow-right"
            (click)="allerSuivant()"
            label="Suivant"
            styleClass="p-button-text"
          ></p-button>
        </div>
      </p-toolbar>
    </p-footer>
  </div>

  } @case (PageNames.FinPage) {
  <div>
    <p-toolbar [style]="{ 'background-color': '#3498db', color: '#ffffff' }">
      <div class="p-toolbar-group-center">
        <i class="pi pi-info-circle" style="font-size: 1.4rem">
          TOTAUX DES CHARGES EXPLOITATIONS:
          {{ this.formatMontant(this.totalECE()) }} FCFA
        </i>
      </div>
    </p-toolbar>
    <br />
    <div class="card flex justify-content-center">
      <p-accordion class="w-full">
        @for (itemTypeCharge of typeChargeExploitations; track $index) {
        <p-accordionTab>
          <ng-template pTemplate="header">
            <div class="flex align-items-center">
              <i
                class="pi pi-folder-open mr-2"
                style="font-size: 2rem; color: orange"
              ></i>
              <span
                class="vertical-align-middle"
                style="font-size: 1.3rem; color: blue"
              >
                {{ itemTypeCharge.name }} | Total:
                {{
                  this.formatMontant(
                    totalECEbyTypeExploitation(itemTypeCharge.id)
                  )
                }}
                FCFA |
              </span>
            </div>
          </ng-template>
          <ng-template pTemplate="content">
            @for (itemCharge of retourneChargesExploitation(itemTypeCharge.id);
            track $index) {
            <div>
              <p-accordion class="w-full">
                <p-accordionTab>
                  <ng-template pTemplate="header">
                    <div class="flex align-items-center">
                      <i
                        class="pi pi-folder-open mr-2"
                        style="font-size: 2rem; color: orange"
                      ></i>
                      <span
                        class="vertical-align-middle"
                        style="font-size: 1.3rem; color: blue"
                      >
                        {{ itemCharge.name }} | Total:
                        {{
                          this.formatMontant(
                            totalECEbyExploitation(itemCharge.id)
                          )
                        }}
                        FCFA |
                      </span>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="content">
                    <table [width]="'100%'">
                      <tr>
                        <th>Date</th>
                        <th>Quatité</th>
                        <th>PU</th>
                        <th>Valeur</th>
                      </tr>
                      @for (itemECE of
                      retourneExploitationChargesExploitation(itemCharge.id);
                      track $index) {
                      <tr>
                        <td>{{ this.formatDate(itemECE.date) }}</td>
                        <td>{{ this.formatMontant(itemECE.quantite) }}</td>
                        <td>{{ this.formatMontant(itemECE.pu) }}</td>
                        <td>
                          {{ this.formatMontant(itemECE.valeur) + " FCFA" }}
                        </td>
                      </tr>
                      } @empty {
                      <p-toolbar
                        [style]="{
                          'background-color': '#3498db',
                          color: '#ffffff'
                        }"
                      >
                        <div class="p-toolbar-group-center">
                          <i
                            class="pi pi-info-circle"
                            style="font-size: 1.4rem"
                          >
                            LIGNE VIDE
                          </i>
                        </div>
                      </p-toolbar>
                      }
                    </table>
                  </ng-template>
                </p-accordionTab>
              </p-accordion>
            </div>
            }
          </ng-template>
        </p-accordionTab>
        }
      </p-accordion>
    </div>

    <br />
    <p-footer>
      <p-toolbar>
        <div class="p-toolbar-group-start">
          <p-button
            icon="pi pi-arrow-left"
            (click)="allerAvant()"
            label="Retour"
            styleClass="p-button-text"
          ></p-button>
        </div>
        <div class="p-toolbar-group-end">
          <p-button
            icon="pi pi-arrow-right"
            (click)="allerSuivant()"
            label="Suivant"
            styleClass="p-button-text"
          ></p-button>
        </div>
      </p-toolbar>
    </p-footer>
  </div>
  } } }
  <p-footer> your footer template </p-footer>
</p-panel>
